{# --- PLANTILLA BUNKER: Basada en chat_template oficial de Qwen con soporte thinking --- #}
{%- if tools %}
<|im_start|>system
{%- if messages[0]['role'] == 'system' %}
{{ messages[0]['content'] }}
{%- else %}
You are Qwen, created by Alibaba Cloud. You are a helpful assistant.
{%- endif %}

# Tools

You may call one or more functions to assist with the user query.

You are provided with function signatures within <tools></tools> XML tags:
<tools>
{%- for tool in tools %}
{{ tool | tojson }}
{%- endfor %}
</tools>

## IMPORTANT: Tool Selection Guidelines

- **For questions about yourself, greetings, or simple conversational queries**: Use `attempt_completion` with your answer in the `result` field. Example: "Who are you?" -> use attempt_completion with result explaining who you are.
- **For unclear or ambiguous task requests**: Use `ask_followup_question` to clarify what the user needs.
- **For file operations, code changes, commands**: Use the appropriate tool (write_to_file, execute_command, read_file, etc.)
- **NEVER use write_to_file or other file tools just to answer a simple question**

## Response Format

You MUST follow this EXACT output format:

1. First, wrap your reasoning inside <think></think> tags (optional)
2. Then, directly output <tool_call></tool_call> with the JSON inside

### Example (YOU MUST COPY THIS EXACT FORMAT):
<think>
The user is asking who I am. This is a simple identity question.
I should use attempt_completion to provide my answer directly.
</think>
<tool_call>
{"name": "attempt_completion", "arguments": {"result": "I am Qwen, an AI assistant..."}}
</tool_call>

### CRITICAL: What NOT to do:
- DO NOT write "TOOL CALL:" as text - use <tool_call> XML tag
- DO NOT write the function name before the JSON
- DO NOT include any text between </think> and <tool_call>

For each function call, return a json object with function name and arguments within <tool_call></tool_call> XML tags:
<tool_call>
{"name": <function-name>, "arguments": <args-json-object>}
</tool_call><|im_end|>
{%- else %}
{%- if messages[0]['role'] == 'system' %}
<|im_start|>system
{{ messages[0]['content'] }}<|im_end|>
{%- else %}
<|im_start|>system
You are Qwen, created by Alibaba Cloud. You are a helpful assistant.<|im_end|>
{%- endif %}
{%- endif %}
{%- for message in messages %}
{%- if (message.role == "user") or (message.role == "system" and not loop.first) or (message.role == "assistant" and not message.tool_calls) %}
<|im_start|>{{ message.role }}
{{ message.content }}<|im_end|>
{%- elif message.role == "assistant" %}
<|im_start|>assistant
{%- if message.content %}
{{ message.content }}
{%- endif %}
{%- for tool_call in message.tool_calls %}
{%- if tool_call.function is defined %}
{%- set tool_call = tool_call.function %}
{%- endif %}
<tool_call>
{"name": "{{ tool_call.name }}", "arguments": {{ tool_call.arguments | tojson }}}
</tool_call>
{%- endfor %}
<|im_end|>
{%- elif message.role == "tool" %}
{%- if (loop.index0 == 0) or (messages[loop.index0 - 1].role != "tool") %}
<|im_start|>user
{%- endif %}
<tool_response>
{{ message.content }}
</tool_response>
{%- if loop.last or (messages[loop.index0 + 1].role != "tool") %}
<|im_end|>
{%- endif %}
{%- endif %}
{%- endfor %}
{%- if add_generation_prompt %}
<|im_start|>assistant
{%- endif %}
