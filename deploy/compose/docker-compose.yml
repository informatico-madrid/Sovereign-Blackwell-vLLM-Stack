services:
  # 1. MOTOR DE INFERENCIA
  vllm-engine:
    image: malkaf/vllm-blackwell-optimizer:latest
    container_name: vllm-engine
    runtime: nvidia
    privileged: true
    ipc: host
    cpuset: ${CPU_SET}
    ports:
      - "8000:8000"
    volumes:
      - "${MODEL_PATH}:/model_dir"
      - "${HF_CACHE_PATH}:/root/.cache/huggingface"
    environment:
      - HUGGING_FACE_HUB_TOKEN
      - VLLM_USE_V1
      - VLLM_NO_USAGE_STATS=1
      - VLLM_ALLOW_LONG_MAX_MODEL_LEN
      - NCCL_P2P_LEVEL
      - VLLM_SKIP_P2P_CHECK
      - NCCL_IGNORE_CPU_AFFINITY
      - NCCL_DMABUF_ENABLE
      - NCCL_SHM_DISABLE=1
      - VLLM_LOG_P2P_ACCESS_CHECK=0
      - VLLM_GPU_ARCH=12.0
      - PYTHONPATH=/vllm-workspace
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: ${VLLM_LAUNCH_COMMAND}
   
  # 2. PROXY LITELLM
  litellm-proxy:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm-proxy
    ports:
      - "4000:4000"
    volumes:
      - ./litellm-config.yaml:/app/config.yaml
    environment:
      - LITELLM_LOG=INFO
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_HOST=http://langfuse-bunker:3000
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
    command: [ "--config", "/app/config.yaml", "--port", "4000" ]
    depends_on:
      - vllm-engine

  # 3. BASE DE DATOS
  db-bunker:
    image: postgres:16
    container_name: db-bunker
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 4. OBSERVABILIDAD
  langfuse-bunker:
    image: langfuse/langfuse:2
    container_name: langfuse-bunker
    depends_on:
      - db-bunker
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - SALT=${SALT}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - LANGFUSE_INIT_PROJECT_NAME=BunkerAI
      - TELEMETRY_ENABLED=false

volumes:
  postgres_data:
    external: true
    name: sovereign-ai-stack_postgres_data
